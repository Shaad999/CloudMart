<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cloud Mart</title>
<style>
body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; padding:0; }
header { background:#fff; padding:15px; text-align:center; font-size:22px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; }
header .logo { height: 40px; border-radius:8px; }
.container { padding:20px; }
.search-bar { margin-bottom:20px; }
input, select, button { padding:10px; margin:5px 0; border:1px solid #ccc; border-radius:5px; }
.product-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:20px; }
.card { background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center; opacity:0; transform:translateY(20px); transition:0.5s; }
.card.show { opacity:1; transform:translateY(0); }
.card img { width:100%; height:140px; object-fit:cover; border-radius:8px; transition:0.3s; }
.card:hover img { transform:scale(1.05); }
.card button { background:#007bff; color:#fff; border:none; padding:10px; width:100%; border-radius:5px; cursor:pointer; transition:0.3s; }
.card button:hover { background:#0056b3; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; opacity:0; transition:0.3s; }
.modal.show { display:flex; opacity:1; }
.modal-content { background:#fff; padding:20px; border-radius:10px; width:350px; max-height:90vh; overflow:auto; animation:fadeIn 0.5s; }
@keyframes fadeIn { from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);} }
.close { float:right; cursor:pointer; font-weight:bold; font-size:20px; }
#bkashFields, #nagadFields { display:none; }
table { width:100%; border-collapse:collapse; margin-top:10px; background:#fff; border-radius:8px; overflow:hidden; }
th, td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background:#007bff; color:#fff; }
#myOrdersBtn { background:#28a745; color:#fff; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; }
#myOrdersBtn:hover { background:#218838; }
</style>
</head>
<body>

<header>
  <div>
    <img src="logo.png" alt="Cloud Mart logo" class="logo">
    <span> Cloud Mart</span>
  </div>
  <button id="myOrdersBtn">ðŸ“¦ My Orders</button>
</header>

<div class="container">
  <h2>Products</h2>
  <div class="search-bar">
    <input type="text" id="search" placeholder="Search product...">
    <select id="categoryFilter"></select>
  </div>
  <div class="product-grid" id="productGrid"></div>
</div>

<!-- Order Modal -->
<div class="modal" id="orderModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('orderModal')">&times;</span>
    <h3>Order Product</h3>
    <form id="orderForm">
      <input type="text" id="orderProduct" readonly><br>
      <input id="orderDescription" readonly ><br>
      <input type="text" id="userName" placeholder="Your Name" required><br>
      <input type="email" id="userEmail" placeholder="Email" required><br>
      <input type="tel" id="userPhone" placeholder="Phone Number" required><br>
      <select id="paymentMethod" required>
        <option value="">Select Payment</option>
        <option value="Bkash">Bkash</option>
        <option value="Nagad">Nagad</option>
      </select><br>
      <div id="bkashFields">
        <p>Bkash Number: <span id="adminBkashNum"></span></p>
        <input type="text" id="sendNumberBkash" placeholder="Your Send Money Number"><br>
        <input type="text" id="trnxIDBkash" placeholder="Transaction ID"><br>
      </div>
      <div id="nagadFields">
        <p>Nagad Number: <span id="adminNagadNum"></span></p>
        <input type="text" id="sendNumberNagad" placeholder="Your Send Money Number"><br>
        <input type="text" id="trnxIDNagad" placeholder="Transaction ID"><br>
      </div>
      <button type="submit">Submit Order</button>
      <button type="button" onclick="closeModal('orderModal')">Cancel</button>
    </form>
  </div>
</div>

<!-- My Orders Modal -->
<div class="modal" id="myOrdersModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('myOrdersModal')">&times;</span>
    <h3>ðŸ“¦ My Orders</h3>
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Payment</th>
          <th>Date</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="orderList"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getDatabase, ref, onValue, push, remove, get, child } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCl9ENd3XOP1KeutD7s1zSiXYSuz4VIqGU",
  authDomain: "cloud-mart01.firebaseapp.com",
  databaseURL: "https://cloud-mart01-default-rtdb.firebaseio.com",
  projectId: "cloud-mart01",
  storageBucket: "cloud-mart01.firebasestorage.app",
  messagingSenderId: "656495467691",
  appId: "1:656495467691:web:fe021039a257495ce12bee",
  measurementId: "G-NG0SHK0SGM"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const productGrid=document.getElementById("productGrid");
const search=document.getElementById("search");
const categoryFilter=document.getElementById("categoryFilter");
const orderProduct=document.getElementById("orderProduct");
const orderDescription=document.getElementById("orderDescription");
const paymentMethod=document.getElementById("paymentMethod");
const bkashFields=document.getElementById("bkashFields");
const nagadFields=document.getElementById("nagadFields");
const adminBkashNum=document.getElementById("adminBkashNum");
const adminNagadNum=document.getElementById("adminNagadNum");
const orderList=document.getElementById("orderList");
const myOrdersBtn=document.getElementById("myOrdersBtn");

let products=[]; 

// Load payment numbers
onValue(ref(db,"payment"), snap=>{
  if(snap.exists()){
    const data=snap.val();
    adminBkashNum.textContent=data.bkash||"";
    adminNagadNum.textContent=data.nagad||"";
  }
});

// Load products
onValue(ref(db,"products"), snap=>{
  products=[];
  if(snap.exists()){
    snap.forEach(child=>{
      products.push({id:child.key,...child.val()});
    });
  }
  renderCategories();
  renderProducts();
});

function renderCategories(){
  let cats=[...new Set(products.map(p=>p.category))];
  categoryFilter.innerHTML=`<option value="">All Categories</option>`;
  cats.forEach(c=>{
    categoryFilter.innerHTML+=`<option value="${c}">${c}</option>`;
  });
}

function renderProducts(){
  let term=search.value.toLowerCase();
  let cat=categoryFilter.value;
  productGrid.innerHTML="";
  products.filter(p=>(!cat||p.category===cat)&&p.name.toLowerCase().includes(term))
    .forEach((p,i)=>{
      let card=document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <img src="${p.image||'https://via.placeholder.com/200'}">
        <h4>${p.name}</h4>
        <p>${p.category}</p>
        <p>${p.description}</p>
        <p><b>$${p.price}</b></p>
        <button onclick="openModal('orderModal','${p.name}','${p.description.replace(/'/g,"&#39;")}')">Order</button>`;
      productGrid.appendChild(card);
      setTimeout(()=>card.classList.add("show"),100*i);
    });
}

window.openModal=function(id,name="",desc=""){
  if(id==="orderModal"){
    orderProduct.value=name;
    orderDescription.value=desc;
  }
  document.getElementById(id).classList.add("show");
}
window.closeModal=function(id){ document.getElementById(id).classList.remove("show"); }

paymentMethod.addEventListener("change",()=>{
  bkashFields.style.display = paymentMethod.value==="Bkash"?"block":"none";
  nagadFields.style.display = paymentMethod.value==="Nagad"?"block":"none";
});


// ===== Invoice Print =====
function printInvoice(order){
  let w=window.open('', '', 'width=800,height=600');
  w.document.write(`
    <html><head><title>Cloud Mart Invoice</title>
    <style>body{font-family:Arial;padding:20px;}h2{text-align:center;}p{margin:5px 0;}hr{margin:15px 0;}</style>
    </head><body>
    <h2>Cloud Mart Invoice</h2>
    <p><b>Date:</b> ${order.date}</p>
    <p><b>Name:</b> ${order.name}</p>
    <p><b>Email:</b> ${order.email}</p>
    <p><b>Phone:</b> ${order.phone}</p>
    <p><b>Product:</b> ${order.product}</p>
    <p><b>Description:</b> ${order.description}</p>
    <p><b>Payment:</b> ${order.payment}</p>
    <p><b>Send Number:</b> ${order.sendNumber}</p>
    <p><b>Transaction ID:</b> ${order.trnx}</p>
    <hr><p style="text-align:center;">âœ… Thank you for your purchase!</p>
    </body></html>
  `);
  w.document.close(); w.print();
}


// Submit order
document.getElementById("orderForm").addEventListener("submit",async e=>{
  e.preventDefault();
  const newOrder={
    product:orderProduct.value,
    description:orderDescription.value,
    name:document.getElementById("userName").value,
    email:document.getElementById("userEmail").value,
    phone:document.getElementById("userPhone").value,
    payment:paymentMethod.value,
    sendNumber:paymentMethod.value==="Bkash"?document.getElementById("sendNumberBkash").value:
                 document.getElementById("sendNumberNagad").value,
    trnx:paymentMethod.value==="Bkash"?document.getElementById("trnxIDBkash").value:
          document.getElementById("trnxIDNagad").value,
    date:new Date().toLocaleString(),
    status:"pending"
  };
  await push(ref(db,"orders"),newOrder);
  alert("Order Submitted!");
  e.target.reset();
  closeModal("orderModal");
});

// Auto delete old orders (keep only last 5)
async function enforceOrderLimit(){
  const snapshot=await get(ref(db,"orders"));
  if(snapshot.exists()){
    let orders=[];
    snapshot.forEach(child=>{
      orders.push({key:child.key,...child.val()});
    });
    if(orders.length>5){
      let toDelete=orders.slice(0,orders.length-5); 
      toDelete.forEach(o=>remove(ref(db,"orders/"+o.key)));
    }
  }
}

// Load orders realtime
onValue(ref(db,"orders"), snap=>{
  orderList.innerHTML="";
  let orders=[];
  if(snap.exists()){
    snap.forEach(child=>orders.push({key:child.key,...child.val()}));
  }
  orders.slice(-5).forEach(o=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${o.product}</td>
      <td>${o.payment}</td>
      <td>${o.date}</td>
      <td style="color:${o.status==="success"?"green":o.status==="failed"?"red":"orange"}">${o.status}</td>`;
    orderList.appendChild(tr);
  });
  enforceOrderLimit();
});

// My Orders button
myOrdersBtn.addEventListener("click",()=>openModal("myOrdersModal"));

search.addEventListener("input",renderProducts);
categoryFilter.addEventListener("change",renderProducts);
</script>
</body>
</html>
